var reverseMidiMapping = new Map([
	[36, 0],
	[35, 0],
	[38, 1],
	[27, 1],
	[28, 1],
	[31, 1],
	[32, 1],
	[33, 1],
	[34, 1],
	[37, 1],
	[39, 1],
	[40, 1],
	[56, 1],
	[65, 1],
	[66, 1],
	[75, 1],
	[85, 1],
	[42, 2],
	[44, 2],
	[54, 2],
	[68, 2],
	[69, 2],
	[70, 2],
	[71, 2],
	[73, 2],
	[78, 2],
	[80, 2],
	[46, 3],
	[67, 3],
	[72, 3],
	[74, 3],
	[79, 3],
	[81, 3],
	[45, 4],
	[29, 4],
	[41, 4],
	[61, 4],
	[64, 4],
	[84, 4],
	[48, 5],
	[47, 5],
	[60, 5],
	[63, 5],
	[77, 5],
	[86, 5],
	[87, 5],
	[50, 6],
	[30, 6],
	[43, 6],
	[62, 6],
	[76, 6],
	[83, 6],
	[49, 7],
	[55, 7],
	[57, 7],
	[58, 7],
	[51, 8],
	[52, 8],
	[53, 8],
	[59, 8],
	[82, 8]
]);

var midiDrums = [36, 38, 42, 46, 41, 43, 45, 49, 51];

var synthMap = {
	"12" : "C2",
	"13" : "C#2",
	"14" : "D2",
	"15" : "D#2",
	"16" : "E2",
	"17" : "F2",
	"18" : "F#2",
	"19" : "G2",
	"20" : "G#2",
	"21" : "A2",
	"22" : "A#2",
	"23" : "B2",
	"24" : "C3",
	"25" : "C#3",
	"26" : "D3",
	"27" : "D#3",
	"28" : "E3",
	"29" : "F3",
	"30" : "F#3",
	"31" : "G3",
	"32" : "G#3",
	"33" : "A3",
	"34" : "A#3",
	"35" : "B3",
	"36" : "C4",
	"37" : "C#4",
	"38" : "D4",
	"39" : "D#4",
	"40" : "E4",
	"41" : "F4",
	"42" : "F#4",
	"43" : "G4",
	"44" : "G#4",
	"45" : "A4",
	"46" : "A#4",
	"47" : "B4",
	"48" : "C5",
	"49" : "C#5",
	"50" : "D5",
	"51" : "D#5",
	"52" : "E5",
	"53" : "F5",
	"54" : "F#5",
	"55" : "G5",
	"56" : "G#5",
	"57" : "A5",
	"58" : "A#5",
	"59" : "B5",
	"60" : "C6",
	"61" : "C#6",
	"62" : "D6",
	"63" : "D#6",
	"64" : "E6",
	"65" : "F6",
	"66" : "F#6",
	"67" : "G6",
	"68" : "G#6",
	"69" : "A6",
	"70" : "A#6",
	"71" : "B6"
}

//---------------------------
// MIDI Controller
//---------------------------
class MIDIAccess {
	constructor(args = {}) {
		this.onDeviceInput = args.onDeviceInput || console.log;
	}

	start() {
		return new Promise((resolve, reject) => {
			this._requestAccess().then(access => {
				this.initialize(access);
				resolve();
			}).catch(() => reject("Something went wrong during MIDI init."));
		});
	}

	initialize(access) {
		const devices = access.inputs.values();
		for (let device of devices) this.initializeDevice(device);
	}

	initializeDevice(device) {
		device.onmidimessage = this.onMessage.bind(this);
	}

	onMessage(message) {
		let [channel, input, velocity] = message.data;
		this.onDeviceInput({input, velocity});
	}

	_requestAccess() {
		return new Promise((resolve, reject) => {
			if(navigator.requestMIDIAccess) 
				navigator.requestMIDIAccess()
					.then(resolve)
					.catch(reject);
			else reject();
		});
	}
}

var midiSynthMap = {
	"36" : "C2",
	"37" : "C#2",
	"38" : "D2",
	"39" : "D#2",
	"40" : "E2",
	"41" : "F2",
	"42" : "F#2",
	"43" : "G2",
	"44" : "G#2",
	"45" : "A2",
	"46" : "A#2",
	"47" : "B2",
	"48" : "C3",
	"49" : "C#3",
	"50" : "D3",
	"51" : "D#3",
	"52" : "E3",
	"53" : "F3",
	"54" : "F#3",
	"55" : "G3",
	"56" : "G#3",
	"57" : "A3",
	"58" : "A#3",
	"59" : "B3",
	"60" : "C4",
	"61" : "C#4",
	"62" : "D4",
	"63" : "D#4",
	"64" : "E4",
	"65" : "F4",
	"66" : "F#4",
	"67" : "G4",
	"68" : "G#4",
	"69" : "A4",
	"70" : "A#4",
	"71" : "B4",
	"72" : "C5",
	"73" : "C#5",
	"74" : "D5",
	"75" : "D#5",
	"76" : "E5",
	"77" : "F5",
	"78" : "F#5",
	"79" : "G5",
	"80" : "G#5",
	"81" : "A5",
	"82" : "A#5",
	"83" : "B5",
	"84" : "C6",
	"85" : "C#6",
	"86" : "D6",
	"87" : "D#6",
	"88" : "E6",
	"89" : "F6",
	"90" : "F#6",
	"91" : "G6",
	"92" : "G#6",
	"93" : "A6",
	"94" : "A#6",
	"95" : "B6",
	"96" : "C7",
	"97" : "C#7",
	"98" : "D7",
	"99" : "D#7",
	"100" : "E7",
	"101" : "F7",
	"102" : "F#7",
	"103" : "G7",
	"104" : "G#7",
	"105" : "A7",
	"106" : "A#7",
	"107" : "B7"
}